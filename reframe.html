<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reframe — Promise</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Plus+Jakarta+Sans:wght@400;500;600&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/base.css">
<style>
/* ── Glass Nav ── */
.glass-nav{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;justify-content:space-between;align-items:center;padding:16px 48px;background:rgba(250,248,245,0.72);backdrop-filter:blur(20px) saturate(1.4);-webkit-backdrop-filter:blur(20px) saturate(1.4);border-bottom:1px solid rgba(232,228,223,0.5);transition:box-shadow .3s}
.glass-nav.scrolled{box-shadow:0 4px 24px rgba(26,26,46,0.06)}
.glass-nav .wordmark{font-family:'DM Serif Display',serif;font-size:20px;color:var(--ink);text-decoration:none}
.glass-nav .wordmark .dot{color:var(--accent)}
.glass-nav .nav-links{display:flex;align-items:center;gap:24px}
.glass-nav .nav-links a{font-size:14px;color:var(--muted);text-decoration:none;font-weight:500;transition:color .2s}
.glass-nav .nav-links a:hover{color:var(--ink)}

/* ── Page ── */
.reframe {
  max-width: 580px;
  margin: 0 auto;
  padding: 100px 24px 80px;
}

/* ── Header ── */
.reframe-header {
  margin-bottom: 36px;
  opacity: 0;
  transform: translateY(16px);
  animation: fadeUp 0.6s ease forwards;
}
.reframe-header h1 {
  font-size: 30px;
  margin-bottom: 6px;
}
.reframe-header h1 .dot { color: var(--accent); }
.reframe-header .sub {
  font-size: 15px;
  color: var(--muted);
  line-height: 1.6;
}

/* ── Promise Card ── */
.promise-card {
  border: 1px dashed #d4b5a6;
  background: #fdfcfb;
  border-radius: 10px;
  padding: 20px 24px;
  margin-bottom: 32px;
  opacity: 0;
  transform: translateY(12px);
  animation: fadeUp 0.5s ease 0.15s forwards;
}
.promise-card .state-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: #8b7a6a;
  margin-bottom: 8px;
}
.promise-card .state-tag svg { width: 14px; height: 14px; }
.promise-card h3 { font-size: 17px; margin-bottom: 4px; }
.promise-card p { font-size: 13px; color: var(--muted); line-height: 1.5; }

/* ── Form ── */
.form-group {
  margin-bottom: 22px;
  opacity: 0;
  transform: translateY(10px);
  animation: fadeUp 0.5s ease forwards;
}
.form-group:nth-child(1) { animation-delay: 0.25s; }
.form-group:nth-child(2) { animation-delay: 0.35s; }
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--ink);
}
.form-group input[type="text"],
.form-group select {
  width: 100%;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 14px;
  padding: 11px 14px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--card);
  color: var(--ink);
  outline: none;
  transition: border-color 0.25s, box-shadow 0.25s;
}
.form-group input:focus,
.form-group select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(244,132,95,0.08);
}

/* ── Actions row ── */
.actions {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-top: 28px;
  opacity: 0;
  animation: fadeUp 0.5s ease 0.45s forwards;
}
.actions .btn {
  padding: 11px 28px;
  font-size: 14px;
  border-radius: 8px;
  transition: background 0.2s, transform 0.15s;
}
.actions .btn:active { transform: scale(0.97); }
.actions .back-link {
  font-size: 14px;
  color: var(--muted);
  text-decoration: none;
  transition: color 0.2s;
}
.actions .back-link:hover { color: var(--ink); }

/* ── Status ── */
#status, #status2 {
  margin-top: 14px;
  font-size: 13px;
  color: var(--muted);
  min-height: 20px;
  transition: color 0.3s;
}
.error { color: #d44 !important; }
.success { color: #2a9d5c !important; }

/* ── AI Loading ── */
.ai-loading {
  display: none;
  flex-direction: column;
  align-items: center;
  padding: 48px 24px;
  gap: 20px;
}
.ai-loading.visible { display: flex; }

.ai-orb {
  width: 56px; height: 56px;
  border-radius: 50%;
  background: radial-gradient(circle at 40% 40%, rgba(244,132,95,0.25), rgba(244,132,95,0.05));
  position: relative;
  animation: orb-breathe 2.4s ease-in-out infinite;
}
.ai-orb::after {
  content: '';
  position: absolute;
  inset: 8px;
  border-radius: 50%;
  border: 2px solid transparent;
  border-top-color: var(--accent);
  border-right-color: var(--accent);
  animation: orb-spin 1.2s linear infinite;
}

@keyframes orb-breathe {
  0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244,132,95,0.15); }
  50% { transform: scale(1.08); box-shadow: 0 0 24px 8px rgba(244,132,95,0.12); }
}
@keyframes orb-spin {
  to { transform: rotate(360deg); }
}

.ai-loading .ai-text {
  font-size: 14px;
  color: var(--muted);
  text-align: center;
  line-height: 1.5;
}
.ai-loading .ai-text strong {
  display: block;
  color: var(--ink);
  font-size: 15px;
  margin-bottom: 4px;
}

.ai-dots {
  display: flex;
  gap: 6px;
}
.ai-dots span {
  width: 5px; height: 5px;
  background: var(--accent);
  border-radius: 50%;
  animation: ai-dot-pulse 1.4s ease-in-out infinite;
}
.ai-dots span:nth-child(2) { animation-delay: 0.2s; }
.ai-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes ai-dot-pulse {
  0%, 80%, 100% { opacity: 0.15; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}

/* ── Solutions ── */
.solutions-wrap {
  display: none;
  margin-top: 8px;
}
.solutions-wrap.visible {
  display: block;
  animation: fadeUp 0.5s ease forwards;
}
.solutions-wrap h2 {
  font-size: 22px;
  margin-bottom: 6px;
}
.solutions-wrap h2 .dot { color: var(--accent); }
.solutions-intro {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 20px;
}

.solution {
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: 10px;
  padding: 18px 22px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: border-color 0.25s, background 0.25s, transform 0.15s, box-shadow 0.25s;
  opacity: 0;
  transform: translateY(10px);
  animation: fadeUp 0.4s ease forwards;
}
.solution:nth-child(1) { animation-delay: 0.05s; }
.solution:nth-child(2) { animation-delay: 0.15s; }
.solution:nth-child(3) { animation-delay: 0.25s; }

.solution:hover {
  border-color: rgba(244,132,95,0.4);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(26,26,46,0.04);
}
.solution:active { transform: scale(0.99); }
.solution.selected {
  border-color: var(--accent);
  background: #fff7f5;
  box-shadow: 0 0 0 3px rgba(244,132,95,0.1);
}
.solution .sol-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--accent);
  margin-bottom: 4px;
}
.solution .sol-text {
  font-size: 14px;
  color: var(--ink);
  line-height: 1.55;
}
.solution .sol-check {
  float: right;
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.25s;
  margin-top: 2px;
}
.solution.selected .sol-check {
  border-color: var(--accent);
  background: var(--accent);
}
.solution.selected .sol-check svg { opacity: 1; }
.sol-check svg {
  width: 12px; height: 12px;
  color: white;
  opacity: 0;
  transition: opacity 0.2s;
}

/* ── Apply Button States ── */
.btn.applying {
  position: relative;
  color: transparent;
  pointer-events: none;
}
.btn.applying::after {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  width: 18px; height: 18px;
  margin: -9px 0 0 -9px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: orb-spin 0.6s linear infinite;
}

/* ── Success state ── */
.reframe-success {
  display: none;
  text-align: center;
  padding: 56px 24px;
}
.reframe-success.visible {
  display: block;
  animation: fadeUp 0.5s ease forwards;
}
.reframe-success svg { color: #7fb069; margin-bottom: 16px; }
.reframe-success h2 {
  font-size: 24px;
  margin-bottom: 8px;
}
.reframe-success p {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 24px;
  line-height: 1.6;
}
.reframe-success .redirect-text {
  font-size: 12px;
  color: #a8a8b8;
  font-style: italic;
}

/* ── Shared Animations ── */
@keyframes fadeUp {
  to { opacity: 1; transform: translateY(0); }
}

/* ── Step transition ── */
.step-leaving {
  animation: fadeOut 0.3s ease forwards;
}
@keyframes fadeOut {
  to { opacity: 0; transform: translateY(-10px); }
}

/* ── Footer ── */
.site-footer {
  background: var(--ink);
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 18px 48px;
  font-size: 12px;
  color: rgba(255,255,255,0.4);
}
.site-footer a {
  color: rgba(255,255,255,0.4);
  text-decoration: none;
  margin-left: 14px;
}
.site-footer a:hover { color: rgba(255,255,255,0.7); }

@media (max-width: 768px) {
  .glass-nav { padding: 14px 24px; }
  .reframe { padding: 80px 20px 64px; }
  .site-footer { padding: 18px 24px; }
}
</style>
</head>
<body>

<nav class="glass-nav" id="nav">
  <a class="wordmark" href="index.html">Promise<span class="dot">.</span></a>
  <div class="nav-links">
    <a href="dashboard.html">Dashboard</a>
    <a href="promise.html" class="btn">Make a Promise</a>
  </div>
</nav>

<main>
  <section class="reframe">
    <!-- Header -->
    <div class="reframe-header">
      <h1>Let's reshape this<span class="dot">.</span></h1>
      <p class="sub">Missing a deadline isn't failure. It's a signal to adjust. The AI will help you find a better path.</p>
    </div>

    <!-- Promise Card -->
    <div class="promise-card" id="missedCard">
      <span class="state-tag">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
        Needs a reset
      </span>
      <h3 id="missedName">Loading...</h3>
      <p id="missedContent"></p>
    </div>

    <!-- Step 1: Reason + Category -->
    <div id="step1">
      <div class="form-group">
        <label for="reason">What happened?</label>
        <input type="text" id="reason" placeholder="e.g. I ran out of time this week" required>
      </div>
      <div class="form-group">
        <label for="category">What best describes it?</label>
        <select id="category">
          <option value="TIME_CONSTRAINT">Time constraint</option>
          <option value="RESOURCE_LIMITATION">Resource limitation</option>
          <option value="EXTERNAL_FACTORS">External factors</option>
          <option value="MOTIVATION_LOSS">Motivation loss</option>
          <option value="UNCLEAR_GOALS">Unclear goals</option>
          <option value="OVERCOMMITMENT">Overcommitment</option>
          <option value="SKILL_GAP">Skill gap</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn" id="generateBtn">Generate Solutions</button>
        <a href="dashboard.html" class="back-link">Back to dashboard</a>
      </div>
      <div id="status"></div>
    </div>

    <!-- AI Loading -->
    <div class="ai-loading" id="aiLoading">
      <div class="ai-orb"></div>
      <div class="ai-text">
        <strong>AI is thinking</strong>
        Analyzing your promise and finding better paths forward...
      </div>
      <div class="ai-dots"><span></span><span></span><span></span></div>
    </div>

    <!-- Step 2: Pick a solution -->
    <div class="solutions-wrap" id="step2">
      <h2>Pick a path forward<span class="dot">.</span></h2>
      <p class="solutions-intro">The AI generated three ways to reshape your promise. Choose the one that feels right.</p>
      <div id="solutionsList"></div>
      <div class="actions">
        <button class="btn" id="applyBtn" disabled>Apply Solution</button>
        <button class="back-link" id="backBtn" style="border:none;background:none;cursor:pointer;font-size:14px;color:var(--muted)">Try again</button>
      </div>
      <div id="status2"></div>
    </div>

    <!-- Success -->
    <div class="reframe-success" id="successState">
      <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
      <h2>Promise reframed!</h2>
      <p>You didn't give up — you adapted. That's what mending looks like.</p>
      <p class="redirect-text">Redirecting to your dashboard...</p>
    </div>
  </section>
</main>

<footer class="site-footer">
  <span>&copy; 2026 Promise.</span>
  <div><a href="#">Privacy</a><a href="#">Terms</a></div>
</footer>

<script type="module">
  let llm = null;
  try {
    llm = await import('./frontend/llm.js');
  } catch (e) {
    console.warn('LLM module not available:', e.message);
  }

  const params = new URLSearchParams(window.location.search);
  const promiseId = params.get('id');
  let missedPromise = null;
  let selectedSolution = null;
  let solutionsRaw = '';

  const statusEl = document.getElementById('status');
  const status2El = document.getElementById('status2');

  function setStatus(el, msg, type) {
    el.textContent = msg;
    el.className = type || '';
  }

  window.addEventListener('scroll', () => {
    document.getElementById('nav').classList.toggle('scrolled', scrollY > 10);
  }, { passive: true });

  // ── Load missed promise by ID from URL param ──
  async function loadMissed() {
    if (!promiseId) {
      window.location.href = 'dashboard.html';
      return;
    }
    try {
      const res = await fetch(`/api/promises/${promiseId}`);
      if (!res.ok) {
        window.location.href = 'dashboard.html';
        return;
      }
      const data = await res.json();
      missedPromise = data;
      document.getElementById('missedName').textContent = data.name;
      document.getElementById('missedContent').textContent = data.content;
    } catch {
      setStatus(statusEl, 'Could not load promise. Is the backend running?', 'error');
    }
  }

  // ── Step 1: Generate solutions ──
  document.getElementById('generateBtn').addEventListener('click', async () => {
    const reason = document.getElementById('reason').value.trim();
    const category = document.getElementById('category').value;
    if (!reason) {
      setStatus(statusEl, 'Please explain what happened.', 'error');
      return;
    }

    const btn = document.getElementById('generateBtn');
    btn.disabled = true;

    // Transition: hide step1, show AI loading
    const step1 = document.getElementById('step1');
    step1.classList.add('step-leaving');
    await new Promise(r => setTimeout(r, 300));
    step1.style.display = 'none';
    document.getElementById('aiLoading').classList.add('visible');

    if (llm) {
      try {
        await llm.initLLM('/models/model.gguf', 'promise-model');
        solutionsRaw = await llm.refinePromise(missedPromise.content, reason, category, missedPromise.promise_type);
        showSolutions(solutionsRaw);
      } catch (err) {
        console.warn('LLM failed:', err.message);
        showFallbackSolutions();
      }
    } else {
      // Simulate brief thinking for demo feel
      await new Promise(r => setTimeout(r, 1500));
      showFallbackSolutions();
    }
    btn.disabled = false;
  });

  function showFallbackSolutions() {
    const raw = missedPromise.content;
    const core = raw.replace(/^I promise I will\s*/i, '');
    solutionsRaw = `1. Conservative Solution:\n- Revised promise: I promise I will ${core}, but with a smaller scope\n\n2. Moderate Solution:\n- Revised promise: I promise I will ${core}, with adjusted expectations\n\n3. Progressive Solution:\n- Revised promise: I promise I will ${core}, and push even further`;
    showSolutions(solutionsRaw);
  }

  function showSolutions(text) {
    // Hide AI loading
    document.getElementById('aiLoading').classList.remove('visible');

    const solutions = [];
    const labels = ['Conservative', 'Moderate', 'Progressive'];

    const parts = text.split(/(?:\d+\.\s*|#{1,3}\s*)(?:conservative|moderate|progressive)\s*solution\s*:?/i);
    for (let i = 1; i < parts.length && solutions.length < 3; i++) {
      const chunk = parts[i].trim();
      const promiseMatch = chunk.match(/(?:[Rr]evised promise:\s*|[-*]\s*)?(I promise I will[^\n]+)/);
      const text_ = promiseMatch ? promiseMatch[1].trim() : chunk.split('\n').filter(l => l.trim() && !l.startsWith('#') && !l.startsWith('---'))[0]?.replace(/^[-*]\s*/, '').trim() || chunk.trim();
      if (text_) solutions.push({ label: labels[solutions.length] || `Option ${solutions.length + 1}`, text: text_ });
    }

    if (!solutions.length) {
      const promises = text.match(/I promise I will[^\n]+/gi) || [];
      for (let i = 0; i < Math.min(promises.length, 3); i++) {
        solutions.push({ label: labels[i], text: promises[i].trim() });
      }
    }

    if (!solutions.length) {
      const lines = text.split('\n').filter(l => l.trim() && !l.startsWith('#'));
      for (let i = 0; i < Math.min(lines.length, 3); i++) {
        solutions.push({ label: labels[i], text: lines[i].replace(/^[-*\d.]\s*/, '').trim() });
      }
    }

    const listEl = document.getElementById('solutionsList');
    listEl.innerHTML = solutions.map((s, i) => `
      <div class="solution" data-idx="${i}" data-label="${s.label}" data-text="${esc(s.text)}">
        <div class="sol-check"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m5 12 5 5L20 7"/></svg></div>
        <div class="sol-label">${s.label}</div>
        <div class="sol-text">${esc(s.text)}</div>
      </div>
    `).join('');

    listEl.querySelectorAll('.solution').forEach(el => {
      el.addEventListener('click', () => {
        listEl.querySelectorAll('.solution').forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
        selectedSolution = { label: el.dataset.label, text: el.dataset.text };
        document.getElementById('applyBtn').disabled = false;
      });
    });

    document.getElementById('step2').classList.add('visible');
  }

  function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  // ── Step 2: Apply solution ──
  document.getElementById('applyBtn').addEventListener('click', async () => {
    if (!selectedSolution) return;

    const btn = document.getElementById('applyBtn');
    btn.disabled = true;
    btn.classList.add('applying');

    const reason = document.getElementById('reason').value.trim();
    const category = document.getElementById('category').value;
    let name = missedPromise.name + ' (revised)';
    let content = selectedSolution.text;
    let deadline = '24h';

    if (llm) {
      try {
        setStatus(status2El, 'AI is refining your new promise...');
        const updated = await llm.generateUpdatedPromise(
          missedPromise.content, reason, category, selectedSolution.label
        );
        const parsed = llm.parseUpdate(updated);
        if (parsed.name) name = parsed.name;
        if (parsed.promise) content = parsed.promise;
        if (parsed.deadline) deadline = parsed.deadline;
      } catch (err) {
        console.warn('LLM update failed, using defaults:', err.message);
      }
    }

    try {
      setStatus(status2El, 'Saving...');
      const body = new FormData();
      body.append('name', name);
      body.append('content', content);
      body.append('deadline', deadline);

      const id = missedPromise.id;
      const res = await fetch(`/api/reframe/${id}/apply`, { method: 'POST', body });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'Failed to apply');
      }

      // Show success state
      document.getElementById('step2').classList.remove('visible');
      document.querySelector('.promise-card').style.display = 'none';
      document.querySelector('.reframe-header').style.display = 'none';
      document.getElementById('successState').classList.add('visible');

      setTimeout(() => { window.location.href = 'dashboard.html'; }, 2200);
    } catch (err) {
      setStatus(status2El, err.message, 'error');
      btn.disabled = false;
      btn.classList.remove('applying');
    }
  });

  // ── Back button ──
  document.getElementById('backBtn').addEventListener('click', () => {
    document.getElementById('step2').classList.remove('visible');
    const step1 = document.getElementById('step1');
    step1.style.display = '';
    step1.classList.remove('step-leaving');
    selectedSolution = null;
  });

  loadMissed();
</script>
</body>
</html>
