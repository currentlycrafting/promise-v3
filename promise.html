<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Make a Promise</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/base.css">
<link rel="stylesheet" href="css/nav.css">
<link rel="stylesheet" href="css/sections.css">
<link rel="stylesheet" href="css/promise.css">
</head>
<body>

<nav id="nav">
  <a class="wordmark" href="index.html">Promise<span class="dot">.</span></a>
  <div class="nav-r">
    <a href="dashboard.html">View Promises</a>
    <a href="promise.html" class="btn">Make a Promise</a>
  </div>
</nav>

<main>
  <section class="promise-page">
    <h1>Make a promise<span class="dot">.</span></h1>
    <p class="sub">What are you committing to?</p>

    <form id="promiseForm">
      <div class="form-group">
        <label>Type</label>
        <div class="type-pills">
          <button type="button" class="type-pill active" data-type="self">Yourself</button>
          <button type="button" class="type-pill" data-type="others">Others</button>
          <button type="button" class="type-pill" data-type="world">The World</button>
        </div>
      </div>

      <div class="form-group">
        <label for="title">Promise</label>
        <input type="text" id="title" placeholder="Run a half marathon" required>
      </div>

      <div class="form-group">
        <label for="details">Details (optional)</label>
        <textarea id="details" placeholder="Any context or specifics you want to remember."></textarea>
      </div>

      <div class="form-group">
        <label for="deadline">Deadline</label>
        <input type="text" id="deadline" placeholder="e.g. 2h, 7d, 1d 12h" required>
        <p class="hint">How long do you have? Use d (days), h (hours), m (minutes).</p>
      </div>

      <div class="promise-actions">
        <button type="submit" class="btn" id="commitBtn">Commit</button>
        <a href="index.html" class="back">Back</a>
      </div>

      <div id="status"></div>
    </form>
  </section>
</main>

<footer>
  <span>&copy; 2026 Promise.</span>
  <div><a href="#">Privacy</a><a href="#">Terms</a></div>
</footer>

<script type="module">
  // Try importing LLM — if it fails (no model, no RunAnywhere), we fall back to direct submit
  let llm = null;
  try {
    llm = await import('./frontend/llm.js');
  } catch (e) {
    console.warn('LLM module not available, using direct submit:', e.message);
  }

  const form = document.getElementById('promiseForm');
  const statusEl = document.getElementById('status');
  const commitBtn = document.getElementById('commitBtn');

  // Type pill selection
  document.querySelectorAll('.type-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      document.querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
    });
  });

  // Scroll shadow
  window.addEventListener('scroll', () => {
    document.getElementById('nav').classList.toggle('scrolled', scrollY > 10);
  }, { passive: true });

  function setStatus(msg, type) {
    statusEl.textContent = msg;
    statusEl.className = type || '';
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    commitBtn.disabled = true;

    const title = document.getElementById('title').value.trim();
    const details = document.getElementById('details').value.trim();
    const deadline = document.getElementById('deadline').value.trim();
    const promiseType = document.querySelector('.type-pill.active')?.dataset.type || 'self';

    if (!title || !deadline) {
      setStatus('Please fill in the promise and deadline.', 'error');
      commitBtn.disabled = false;
      return;
    }

    let name = title;
    let content = details ? `${title} — ${details}` : `I promise I will ${title.toLowerCase()}`;

    // If LLM is available, use it to format the promise
    if (llm) {
      try {
        setStatus('Loading AI model...');
        await llm.initLLM('/models/model.gguf', 'promise-model');

        setStatus('Formatting your promise...');
        const rawText = details ? `${title}. ${details}` : title;
        const formatted = await llm.formatNewPromise(rawText);
        const parsed = llm.parseCreate(formatted);

        if (parsed.name) name = parsed.name;
        if (parsed.promise) content = parsed.promise;
      } catch (err) {
        console.warn('LLM formatting failed, using raw input:', err.message);
        setStatus('AI unavailable, submitting directly...');
      }
    }

    // POST to backend
    try {
      setStatus('Saving your promise...');
      const body = new FormData();
      body.append('name', name);
      body.append('promise_type', promiseType);
      body.append('content', content);
      body.append('deadline', deadline);

      const res = await fetch('/api/promises', { method: 'POST', body });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'Failed to create promise');
      }

      setStatus('Promise created!', 'success');
      setTimeout(() => { window.location.href = 'dashboard.html'; }, 800);
    } catch (err) {
      setStatus(err.message, 'error');
      commitBtn.disabled = false;
    }
  });
</script>
</body>
</html>
