<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Make a Promise</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Plus+Jakarta+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/base.css">
<link rel="stylesheet" href="css/nav.css">
<link rel="stylesheet" href="css/sections.css">
<link rel="stylesheet" href="css/promise.css">
<style>
/* ── Loading animations ── */
@keyframes spin {
  to { transform: rotate(360deg); }
}
@keyframes dot-pulse {
  0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
  40% { opacity: 1; transform: scale(1); }
}
@keyframes thinking-dots {
  0%  { content: '.'; }
  33% { content: '..'; }
  66% { content: '...'; }
}
@keyframes fade-check {
  0%   { opacity: 0; transform: scale(0.6); }
  50%  { opacity: 1; transform: scale(1.1); }
  100% { opacity: 1; transform: scale(1); }
}

#commitBtn.loading {
  position: relative;
  color: transparent;
  pointer-events: none;
}
#commitBtn.loading::after {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  width: 18px; height: 18px;
  margin: -9px 0 0 -9px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

#commitBtn.thinking {
  opacity: 0.7;
  pointer-events: none;
}
#commitBtn.thinking .btn-text::after {
  content: '.';
  animation: thinking-dots 1.2s steps(3, end) infinite;
}

#commitBtn.saved .btn-text {
  animation: fade-check 0.4s ease forwards;
}

.pulse-dots {
  display: none;
  gap: 6px;
  justify-content: center;
  margin-top: 8px;
}
.pulse-dots.visible { display: flex; }
.pulse-dots span {
  width: 6px; height: 6px;
  background: var(--accent);
  border-radius: 50%;
  animation: dot-pulse 1.4s ease-in-out infinite;
}
.pulse-dots span:nth-child(2) { animation-delay: 0.2s; }
.pulse-dots span:nth-child(3) { animation-delay: 0.4s; }
</style>
</head>
<body>

<nav class="glass-nav" id="nav">
  <a class="wordmark" href="index.html">Promise<span class="dot">.</span></a>
  <div class="nav-links">
    <a href="dashboard.html">Dashboard</a>
    <a href="promise.html" class="btn">Make a Promise</a>
  </div>
</nav>
<style>
.glass-nav{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;justify-content:space-between;align-items:center;padding:16px 48px;background:rgba(250,248,245,0.72);backdrop-filter:blur(20px) saturate(1.4);-webkit-backdrop-filter:blur(20px) saturate(1.4);border-bottom:1px solid rgba(232,228,223,0.5);transition:box-shadow .3s}
.glass-nav.scrolled{box-shadow:0 4px 24px rgba(26,26,46,0.06)}
.glass-nav .wordmark{font-family:'DM Serif Display',serif;font-size:20px;color:var(--ink);text-decoration:none}
.glass-nav .wordmark .dot{color:var(--accent)}
.glass-nav .nav-links{display:flex;align-items:center;gap:24px}
.glass-nav .nav-links a{font-size:14px;color:var(--muted);text-decoration:none;font-weight:500;transition:color .2s}
.glass-nav .nav-links a:hover{color:var(--ink)}
</style>

<main style="padding-top:64px;">
  <section class="promise-page">
    <h1>Make a promise<span class="dot">.</span></h1>
    <p class="sub">What are you committing to?</p>

    <form id="promiseForm">
      <div class="form-group">
        <label>Type</label>
        <div class="type-pills">
          <button type="button" class="type-pill active" data-type="self">Yourself</button>
          <button type="button" class="type-pill" data-type="others">Others</button>
          <button type="button" class="type-pill" data-type="world">The World</button>
        </div>
      </div>

      <div class="form-group">
        <label for="title">Promise</label>
        <input type="text" id="title" placeholder="Run a half marathon" required>
      </div>

      <div class="form-group">
        <label for="details">Details (optional)</label>
        <textarea id="details" placeholder="Any context or specifics you want to remember."></textarea>
      </div>

      <div class="form-group">
        <label for="deadline">Deadline</label>
        <input type="text" id="deadline" placeholder="e.g. 2h, 7d, 1d 12h" required>
        <p class="hint">How long do you have? Use d (days), h (hours), m (minutes).</p>
      </div>

      <div class="promise-actions">
        <button type="submit" class="btn" id="commitBtn"><span class="btn-text">Commit</span></button>
        <a href="index.html" class="back">Back</a>
      </div>

      <div id="status"></div>
      <div class="pulse-dots" id="pulseDots"><span></span><span></span><span></span></div>
    </form>
  </section>
</main>

<footer class="site-footer" style="background:var(--ink);display:flex;justify-content:space-between;align-items:center;padding:18px 48px;font-size:12px;color:rgba(255,255,255,0.4)">
  <span>&copy; 2026 Promise.</span>
  <div><a href="#" style="color:rgba(255,255,255,0.4);text-decoration:none;margin-left:14px">Privacy</a><a href="#" style="color:rgba(255,255,255,0.4);text-decoration:none;margin-left:14px">Terms</a></div>
</footer>

<script type="module">
  let llm = null;
  try {
    llm = await import('./frontend/llm.js');
  } catch (e) {
    console.warn('LLM module not available, using direct submit:', e.message);
  }

  const form = document.getElementById('promiseForm');
  const statusEl = document.getElementById('status');
  const commitBtn = document.getElementById('commitBtn');
  const btnText = commitBtn.querySelector('.btn-text');
  const pulseDots = document.getElementById('pulseDots');

  // Type pill selection
  document.querySelectorAll('.type-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      document.querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
    });
  });

  // Scroll shadow
  window.addEventListener('scroll', () => {
    document.getElementById('nav').classList.toggle('scrolled', scrollY > 10);
  }, { passive: true });

  function setStatus(msg, type) {
    statusEl.textContent = msg;
    statusEl.className = type || '';
  }

  function setBtnState(state) {
    commitBtn.classList.remove('loading', 'thinking', 'saved');
    pulseDots.classList.remove('visible');
    commitBtn.disabled = false;

    if (state === 'loading') {
      commitBtn.classList.add('loading');
      commitBtn.disabled = true;
      pulseDots.classList.add('visible');
    } else if (state === 'thinking') {
      commitBtn.classList.add('thinking');
      commitBtn.disabled = true;
      btnText.textContent = 'Thinking';
    } else if (state === 'saving') {
      commitBtn.classList.add('loading');
      commitBtn.disabled = true;
    } else if (state === 'saved') {
      commitBtn.classList.add('saved');
      commitBtn.disabled = true;
      btnText.textContent = '\u2713';
    } else {
      btnText.textContent = 'Commit';
    }
  }

  // Pre-load LLM in background
  if (llm) {
    setStatus('Loading AI model...');
    setBtnState('loading');
    llm.initLLM('/models/model.gguf', 'promise-model')
      .then(() => {
        setStatus('AI ready \u2014 faster next time.', 'success');
        setBtnState('idle');
        setTimeout(() => setStatus(''), 3000);
      })
      .catch(() => {
        setStatus('AI unavailable, direct submit enabled.');
        setBtnState('idle');
      });
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const title = document.getElementById('title').value.trim();
    const details = document.getElementById('details').value.trim();
    const deadline = document.getElementById('deadline').value.trim();
    const promiseType = document.querySelector('.type-pill.active')?.dataset.type || 'self';

    if (!title || !deadline) {
      setStatus('Please fill in the promise and deadline.', 'error');
      return;
    }

    let name = title;
    let content = details ? `${title} — ${details}` : `I promise I will ${title.toLowerCase()}`;

    // If LLM is available, use it to format the promise
    if (llm) {
      try {
        setBtnState('thinking');
        setStatus('Formatting your promise...');
        const rawText = details ? `${title}. ${details}` : title;
        const formatted = await llm.formatNewPromise(rawText);
        const parsed = llm.parseCreate(formatted);

        if (parsed.name) name = parsed.name;
        if (parsed.promise) content = parsed.promise;
      } catch (err) {
        console.warn('LLM formatting failed, using raw input:', err.message);
        setStatus('AI unavailable, submitting directly...');
      }
    }

    // POST to backend
    try {
      setBtnState('saving');
      setStatus('Saving your promise...');
      const body = new FormData();
      body.append('name', name);
      body.append('promise_type', promiseType);
      body.append('content', content);
      body.append('deadline', deadline);

      const res = await fetch('/api/promises', { method: 'POST', body });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'Failed to create promise');
      }

      setBtnState('saved');
      setStatus('Promise created!', 'success');
      setTimeout(() => { window.location.href = 'dashboard.html'; }, 800);
    } catch (err) {
      setStatus(err.message, 'error');
      setBtnState('idle');
    }
  });
</script>
</body>
</html>
